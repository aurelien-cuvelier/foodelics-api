generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Chef_ranks {
  APPRENTICE_CHEF
  SOUS_CHEF
  EXECUTIVE_CHEF
  HEAD_CHEF
  MICHELIN_STARRED_CHEF
  CHEF_PATRON
  MASTER_CHEF
  CULINARY_DIRECTORY
}

enum Meal_type {
  MAIN_DISH
  SIDE_DISH
  DESSERT
}

enum Tags {
  VEGAN
  VEGETARIAN
  GLUTEN_FREE
  DAIRY_FREE
  LOW_CARB
  PALEO
  KOSHER
  HALAL
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum Units {
  GRAM
  KILOGRAM
  MILILITER
  LITER
  TABLESPOON
  TEASPOON
  PIECE
}

model User {
  id       Int     @id @unique @default(autoincrement())
  username String  @unique
  address  String  @unique
  avatar   String?
  bio      String?
  country  String
  twitter  String?
  discord  String?

  chef_rank Chef_ranks @default(APPRENTICE_CHEF)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  //Each user can create several recipes
  recipes Recipe[] @relation("CreatedRecipes")

  //Each user can create several reviews
  reviews Review[] @relation("CreatedReviews")

  //Each user has a single country
  countryFk Country @relation("UserCountry", fields: [country], references: [a3])

  //Each user can have several followers
  followers Follow[] @relation("Following")

  //Each user can follow several users
  following Follow[] @relation("Followers")

  @@map("users")
}

model Follow {
  followerId Int
  
  //The user who is following
  follower   User @relation("Followers", fields: [followerId], references: [id])

  followingId Int

  //Who the follower is following
  following   User @relation("Following", fields: [followingId], references: [id])

  @@id([followerId, followingId])
  @@map("follows")
}

model Recipe {
  id             Int           @id @unique @default(autoincrement())
  name           String
  description    String
  country        String        // ISO 3166
  images         String[]
  duration       Int           // minutes
  diffulty       Difficulty
  recipe         String        // Cooking instructions
  meal_role      Meal_type
  tags           Tags[]
  overall_rating Decimal        // 1, 1.5, 2, 2.5, ..., 5

  created_at     DateTime      @default(now())
  updated_at     DateTime      @updatedAt

  created_by     Int
  //A recipe is created by a single user
  recipeCreatorFk User         @relation("CreatedRecipes", fields: [created_by], references: [id])

  //A recipe can have several reviews
  reviews        Review[]      @relation("ReviewedRecipes")

  //A recipe is composed of several items [ingredient_id,unit,quantity]
  items          Recipe_item[]

    //Each recipe has a single country
  countryFk Country @relation("RecipeCountry", fields: [country], references: [a3])

  @@map("recipes")
}

model Recipe_item {
  id           Int     @id @unique @default(autoincrement())
  ingedient_id Int
  unit         Units
  quantity     Decimal

  recipe_id    Int
  //A recipe item is linked to a single recipe
  recipe       Recipe @relation(fields: [recipe_id], references: [id]) // Connect Recipe_item to Recipe

  //A recipe item is linked to a single ingredient
  ingredient   Ingredient @relation(fields: [ingedient_id], references: [id])

  @@map("recipe_items")
}

model Review {
  id         Int      @id @unique @default(autoincrement())
  created_at DateTime @default(now())

  reviewed_by    Int
  //A review has a single author
  reviewAuthorFk User @relation("CreatedReviews", fields: [reviewed_by], references: [id])

  reviewed_recipe   Int
  //A review belongs to a single recipe
  reviewedRecipedFk Recipe @relation("ReviewedRecipes", fields: [reviewed_recipe], references: [id])

  @@map("reviews")
}

model Ingredient {
  id          Int     @id @default(autoincrement())
  name        String @unique()
  description String?
  thumbnail   String?

  //An ingredient can be used in several recipe items
  used_in Recipe_item[]

  @@map("ingredients")
}

model Country {
  //ISO 3166

  id Int @id @default(autoincrement())

  name String @unique()
  a2   String @unique()
  a3   String @unique()
  flag String?

  //A country can have several users
  users User[] @relation("UserCountry")

  recipes Recipe[] @relation("RecipeCountry")

  @@map("countries")
}
